(()=>{var t;!function(t){t.LOAD="LOAD",t.EXEC="EXEC",t.WRITE_FILE="WRITE_FILE",t.READ_FILE="READ_FILE",t.DELETE_FILE="DELETE_FILE",t.RENAME="RENAME",t.CREATE_DIR="CREATE_DIR",t.LIST_DIR="LIST_DIR",t.DELETE_DIR="DELETE_DIR",t.ERROR="ERROR",t.DOWNLOAD="DOWNLOAD",t.PROGRESS="PROGRESS",t.LOG="LOG",t.MOUNT="MOUNT",t.UNMOUNT="UNMOUNT"}(t||(t={}));const e=(()=>{let t=0;return()=>t++})(),s=(new Error("unknown message type"),new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first")),a=new Error("called FFmpeg.terminate()");new Error("failed to import ffmpeg-core.js");class i{#t=null;#e={};#s={};#a=[];#i=[];t=!1;#o=()=>{this.#t&&(this.#t.onmessage=({data:{id:e,type:s,data:a}})=>{switch(s){case t.LOAD:this.t=!0,this.#e[e](a);break;case t.MOUNT:case t.UNMOUNT:case t.EXEC:case t.WRITE_FILE:case t.READ_FILE:case t.DELETE_FILE:case t.RENAME:case t.CREATE_DIR:case t.LIST_DIR:case t.DELETE_DIR:this.#e[e](a);break;case t.LOG:this.#a.forEach((t=>t(a)));break;case t.PROGRESS:this.#i.forEach((t=>t(a)));break;case t.ERROR:this.#s[e](a)}delete this.#e[e],delete this.#s[e]})};#n=({type:t,data:a},i=[],o)=>this.#t?new Promise(((s,n)=>{const r=e();this.#t&&this.#t.postMessage({id:r,type:t,data:a},i),this.#e[r]=s,this.#s[r]=n,o?.addEventListener("abort",(()=>{n(new DOMException(`Message # ${r} was aborted`,"AbortError"))}),{once:!0})})):Promise.reject(s);i(t,e){"log"===t?this.#a.push(e):"progress"===t&&this.#i.push(e)}o(t,e){"log"===t?this.#a=this.#a.filter((t=>t!==e)):"progress"===t&&(this.#i=this.#i.filter((t=>t!==e)))}h=({classWorkerURL:e,...s}={},{signal:a}={})=>(this.#t||(this.#t=new Worker(`chrome-extension://${chrome.runtime.id}/js/worker.js`),this.#o()),this.#n({type:t.LOAD,data:s},void 0,a));l=(e,s=-1,{signal:a}={})=>this.#n({type:t.EXEC,data:{args:e,timeout:s}},void 0,a);_=()=>{const t=Object.keys(this.#s);for(const e of t)this.#s[e](a),delete this.#s[e],delete this.#e[e];this.#t&&(this.#t.terminate(),this.#t=null,this.t=!1)};p=(e,s,{signal:a}={})=>{const i=[];return s instanceof Uint8Array&&i.push(s.buffer),this.#n({type:t.WRITE_FILE,data:{path:e,data:s}},i,a)};m=(e,s,a)=>this.#n({type:t.MOUNT,data:{fsType:e,options:s,mountPoint:a}},[]);u=e=>this.#n({type:t.UNMOUNT,data:{mountPoint:e}},[]);g=(e,s="binary",{signal:a}={})=>this.#n({type:t.READ_FILE,data:{path:e,encoding:s}},void 0,a);$=(e,{signal:s}={})=>this.#n({type:t.DELETE_FILE,data:{path:e}},void 0,s);v=(e,s,{signal:a}={})=>this.#n({type:t.RENAME,data:{oldPath:e,newPath:s}},void 0,a);R=(e,{signal:s}={})=>this.#n({type:t.CREATE_DIR,data:{path:e}},void 0,s);L=(e,{signal:s}={})=>this.#n({type:t.LIST_DIR,data:{path:e}},void 0,s);k=(e,{signal:s}={})=>this.#n({type:t.DELETE_DIR,data:{path:e}},void 0,s)}chrome.runtime.onMessage.addListener(((t,e,s)=>{"offscreen"===t.target&&"start"===t.action&&o.D(t.data,t.process_id)}));const o={P:null,O:.5,U(){this.P&&this.P._(),this.P=null},A(t){const e=chrome.runtime.connect({name:`offscreen_${Math.random().toString()}`});let s=0;return function(a){if(a.percents){if(a.percents===s)return;s=a.percents}e.postMessage({action:"download_step",process_id:t,details:a})}},D(t,e){const s=this;let a;const i=s.A(e);Promise.resolve().then((function(){return s.F(t,i)})).then((()=>s.I(t.video_file,t.audio_file,i))).then((e=>(a=URL.createObjectURL(new Blob([e],{type:"video/mp4"})),chrome.runtime.sendMessage({action:"download_file",url:a,filename:t.filename})))).finally((function(){s.U(),URL.revokeObjectURL(a)})).then((t=>{t.success?i({done:!0}):i({failed:!0})})).catch((function(t){i({failed:!0,e:t.toString()})}))},F(t,e){const s=this;let a=0;const i=function(i){a+=i;let o=Math.ceil(a/t.fileSizeBytes*s.O*100);e({percents:o})};return Promise.all([s.j(t.video_url,i),s.j(t.audio_url,i)]).then((function(e){t.video_file=e[0],t.audio_file=e[1]}))},async j(t,e){let s=await fetch(t);const a=s.body.getReader(),i=parseInt(s.headers.get("Content-Length"));let o=new Uint8Array(i),n=0;for(;;){const{done:t,value:s}=await a.read();if(t)break;o.set(s,n),n+=s.length,e(s.length)}return o},async I(t,e,s){const a=this;null===this.P&&(this.P=new i,this.P.i("progress",(({progress:t})=>{let e=100*a.O+Math.ceil(t*(1-a.O)*100);e>100&&(e=100),s({percents:e})})),await this.P.h({coreURL:`chrome-extension://${chrome.runtime.id}/js/wasm/ffmpeg-core.js`,wasmURL:`chrome-extension://${chrome.runtime.id}/js/wasm/ffmpeg-core.wasm`})),await this.P.p("video.mp4",t),await this.P.p("audio.mp4",e),await this.P.l("-i video.mp4 -i audio.mp4 -map 0:v -map 1:a -c:v copy -y output.mp4".split(" "));return(await this.P.g("output.mp4")).buffer}}})();